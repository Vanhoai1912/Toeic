<div id="chat-container">
    <div id="chat-header">Chatbot</div>
    <div id="chat-body"></div>

    <!-- Hai nút để chọn loại chat -->
    <button class="chat-option" data-chat="ai">Chat với AI</button>
    <button class="chat-option" data-chat="admin">Chat với Admin</button>

    <input type="text" id="chat-input" placeholder="Nhập tin nhắn...">
    <button id="send-btn">Gửi</button>
</div>


<style>
    #chat-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 300px;
        background: white;
        border: 1px solid #ccc;
        box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.2);
        border-radius: 10px;
    }

    #chat-header {
        background: #007bff;
        color: white;
        padding: 10px;
        text-align: center;
        font-weight: bold;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
    }

    #chat-body {
        height: 300px;
        overflow-y: auto;
        padding: 10px;
    }

    #chat-input {
        width: 80%;
        padding: 8px;
        border: none;
        border-top: 1px solid #ccc;
    }

    #send-btn {
        width: 20%;
        background: #007bff;
        color: white;
        border: none;
        padding: 8px;
        cursor: pointer;
    }
</style>
<script>
    let chatType = "ai";
    let hasAdminMessageShown = false;

    let aiMessages = [];
    let adminMessages = [];

    const chatHeader = document.getElementById("chat-header");
    const chatBody = document.getElementById("chat-body");
    const chatInput = document.getElementById("chat-input");
    const sendBtn = document.getElementById("send-btn");

    const scrollToBottom = () => chatBody.scrollTop = chatBody.scrollHeight;

    const showMessage = (sender, message, color = "black") => {
        const messageHtml = `<div style="color: ${color};"><strong>${sender}:</strong> ${message}</div>`;
        chatBody.insertAdjacentHTML("beforeend", messageHtml);

        if (chatType === "ai") {
            aiMessages.push(messageHtml);
        } else {
            adminMessages.push(messageHtml);
        }

        scrollToBottom();
    };

    const showError = (message) => {
        showMessage("Lỗi", message, "red");
    };

    document.querySelectorAll(".chat-option").forEach(button => {
        button.addEventListener("click", function () {
            chatType = this.dataset.chat;
            chatHeader.textContent = chatType === "admin" ? "Chat với Admin" : "Chatbot AI";
            chatHeader.style.backgroundColor = chatType === "admin" ? "#dc3545" : "#007bff";

            chatBody.innerHTML = `<p style='color: gray; text-align: center;'>Bạn đang chat với ${chatType === "admin" ? "Admin" : "AI"}.</p>`;
            const messages = chatType === "admin" ? adminMessages : aiMessages;
            messages.forEach(msg => chatBody.insertAdjacentHTML("beforeend", msg));

            if (chatType === "admin" && !hasAdminMessageShown) {
                const adminNotification = "<div style='color: green; font-style: italic;'>Hãy để lại tin nhắn, Admin sẽ trả lời bạn trong vài giờ.</div>";
                chatBody.insertAdjacentHTML("beforeend", adminNotification);
                adminMessages.push(adminNotification);
                hasAdminMessageShown = true;
            }

            scrollToBottom();
        });
    });

    const sendMessage = async () => {
        const input = chatInput.value.trim();
        if (input === "") return;

        showMessage("Bạn", input);
        chatInput.value = "";

        try {
            const response = await fetch(`/customer/api/chat/send/${chatType}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ messageText: input })
            });

            const body = await response.json();

            if (!response.ok) {
                const errorMessage = body?.error || "Đã xảy ra lỗi không xác định.";
                showError(errorMessage);
                return;
            }

            if (chatType === "admin" && !hasAdminMessageShown) {
                const adminNotification = "<div style='color: red; font-style: italic;'>Admin sẽ trả lời bạn trong vài giờ.</div>";
                chatBody.insertAdjacentHTML("beforeend", adminNotification);
                adminMessages.push(adminNotification);
                hasAdminMessageShown = true;
            }

            if (body.reply?.trim()) {
    showMessage(chatType === "ai" ? "Chatbot" : "Admin", body.reply);
} else if (body.success) {
    setTimeout(() => {
    showMessage("Hệ thống", "Tin nhắn đã gửi thành công.", "gray");
}, 1000); // Chậm 1 giây

} else {
    showError("Không nhận được phản hồi.");
}

        } catch (error) {
            showError("Không thể kết nối đến server. Vui lòng kiểm tra mạng.");
        }
    };

    sendBtn.addEventListener("click", sendMessage);
    chatInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendMessage();
    });
</script>







